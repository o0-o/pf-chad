#!/usr/bin/env sh

set -euo pipefail
set -x

# parse aguments
while [ ! -z ${1-} ]; do
	case "$1" in
		--ip)
			typeset ipv4=$2
			shift 2
			;;
		--mask)
			typeset mask=$2
			shift 2
			;;
		--hop)
			typeset next_hop=$2
			shift 2
			;;
		--iface)
			typeset iface=$2
			shift 2
			;;
		--vlan)
			typeset vlan=$2
			shift 2
			;;
		--description)
			typeset description=$2
			shift 2
			;;
		*)
			echo "Not recognized: $1" >&2
			exit 1
			;;
	esac
done

# set edge/wan interface to up
typeset	iface_cfg="hostname.${iface}"
grep	-q "^up$"	"/etc/${iface_cfg}"		||
{	touch			"/etc/${iface_cfg}"
	mv	"/etc/${iface_cfg}"	'/tmp'
	sed	-e '1iup'	"/tmp/${iface_cfg}"	"/etc/${iface_cfg}"
}
# if vlan, switch to vlan conf file
[ -z ${vlan-} ]	||
{	typeset	iface_cfg="hostname.vlan${vlan}"
	# interface
	printf	'%s\n'					\
		"vnetid ${vlan} parent ${iface}"	\
		'up'					\
	>	"/etc/${iface_cfg}"
	typeset	parent_iface="${iface}"
	typeset	iface="vlan${vlan}"
}
# finish configuring interface
printf	'%s\n'					\
	'lladdr random'				\
	"inet ${ipv4}/${mask}"			\
	>>	"/etc/${iface_cfg}"
printf	'%s\n'					\
	"description ${description-WAN}"	\
	>>	"/etc/${iface_cfg}"
# antispoof rule
printf	'%s | %s\n'					\
	"!echo 'antispoof quick log for ${iface}'"	\
	"pfctl -a ${iface} -f -"			\
	>>	"/etc/${iface_cfg}"

# default gateway
printf	'%s\n'			\
	"${next_hop}"		\
	>	'/etc/mygate'

# temporarily use quadnine
printf	'%s\n'				\
	'nameserver 9.9.9.9'		\
	'lookup file bind'		\
	>	'/etc/resolv.conf'

# bring up the network
sh	'/etc/netstart'

# install most updated pf-chad rules
which	git	||
pkg_add	git
[ ! -e '/tmp/pf-chad' ]		||
rm	-rf	'/tmp/pf-chad'
git	clone	--depth 1			\
	'https://github.com/o0-o/pf-chad.git'	\
	'/tmp/pf-chad'
cp	-a	'/etc/pf.conf'		\
		'/etc/.pf.conf.default'
cp	-a	'/tmp/pf-chad/etc'	\
		'/'
rm -rf '/tmp/pf-chad'
# allow this host to access the internet
printf	'%s\n'					\
	"!pfctl -t wan-c -T add ${iface}"	\
	>>	"/etc/${iface_cfg}"
pfctl	-nf	'/etc/pf.conf'	&&
pfctl	-f	'/etc/pf.conf'

# unbound
cp	-a	'/var/unbound/etc/unbound.conf'	\
		'/etc/examples/unbound.conf'
sed	-e	's/#tls-cert-bundle/tls-cert-bundle/'	\
	-e	'/hide-identity/ i\
	do-not-query-localhost: no\
\
'	'/etc/examples/unbound.conf'			\
	>	'/var/unbound/etc/unbound.conf'
printf	'%s\n'					\
	'forward-zone:'				\
	>>	'/var/unbound/etc/unbound.conf'
printf	'\t%s\n'						\
	'name: "."'						\
	'forward-tls-upstream: yes'				\
	'forward-first: no'					\
	'forward-addr: 9.9.9.9@853#dns.quad9.net'		\
	'forward-addr: 149.112.112.112@853#dns.quad9.net'	\
	'forward-addr: 1.1.1.1@853#cloudflare-dns.com'		\
	'forward-addr: 1.0.0.1@853#cloudflare-dns.com'		\
	>>	'/var/unbound/etc/unbound.conf'
ftp	-S	do					\
	-o	'/var/unbound/db/root.hints'		\
	'https://www.internic.net/domain/named.root'
unbound-checkconf
rcctl	enable	unbound
rcctl	start	unbound

# nsd
cp	-a	'/var/nsd/etc/nsd.conf'		\
		'/etc/examples/nsd.conf'
sed	-e				\
	'/^server/ a\
	ip-address: 127.0.0.1@5678\
'					\
	'/etc/examples/nsd.conf'	\
	>	'/var/nsd/etc/nsd.conf'
nsd-checkconf	'/var/nsd/etc/nsd.conf'
rcctl	enable	nsd
rcctl	start	nsd

# use local resolver
printf	'%s\n'				\
	'nameserver 127.0.0.1'		\
	'lookup file bind'		\
	>	'/etc/resolv.conf'

sh	'/etc/netstart'

# enable packet forwarding
echo	'net.inet.ip.forwarding=1'	>>	'/etc/sysctl.conf'
sysctl	-w	'net.inet.ip.forwarding=1'

# vim: ts=8:sw=8:sts=8:noet:ft=sh
